From d084663a95334c5337320a85b00a4b05107a34e4 Mon Sep 17 00:00:00 2001
From: Dom Cobley <popcornmix@gmail.com>
Date: Fri, 2 Feb 2024 12:57:15 +0000
Subject: [PATCH] media: rp1: csi2: Squash fixes

---
 .../media/platform/raspberrypi/rp1_cfe/csi2.c | 20 +++++++++++--------
 1 file changed, 12 insertions(+), 8 deletions(-)

--- a/drivers/media/platform/raspberrypi/rp1_cfe/csi2.c
+++ b/drivers/media/platform/raspberrypi/rp1_cfe/csi2.c
@@ -334,7 +334,7 @@ static int csi2_get_vc_dt_fallback(struc
 	state = v4l2_subdev_get_locked_active_state(sd);
 
 	/* Without Streams API, the channel number matches the sink pad */
-	fmt = v4l2_subdev_get_pad_format(sd, state, channel);
+	fmt = v4l2_subdev_state_get_format(state, channel);
 	if (!fmt)
 		return -EINVAL;
 
@@ -476,10 +476,10 @@ static int csi2_init_cfg(struct v4l2_sub
 		else
 			def_fmt = &cfe_default_format;
 
-		fmt = v4l2_subdev_get_pad_format(sd, state, i);
+		fmt = v4l2_subdev_state_get_format(state, i);
 		*fmt = *def_fmt;
 
-		fmt = v4l2_subdev_get_pad_format(sd, state, i + CSI2_NUM_CHANNELS);
+		fmt = v4l2_subdev_state_get_format(state, i + CSI2_NUM_CHANNELS);
 		*fmt = *def_fmt;
 	}
 
@@ -497,13 +497,13 @@ static int csi2_pad_set_fmt(struct v4l2_
 
 		struct v4l2_mbus_framefmt *fmt;
 
-		fmt = v4l2_subdev_get_pad_format(sd, state, format->pad);
+		fmt = v4l2_subdev_state_get_format(state, format->pad);
 		if (!fmt)
 			return -EINVAL;
 
 		*fmt = format->format;
 
-		fmt = v4l2_subdev_get_pad_format(sd, state,
+		fmt = v4l2_subdev_state_get_format(state,
 			format->pad + CSI2_NUM_CHANNELS);
 		if (!fmt)
 			return -EINVAL;
@@ -520,12 +520,12 @@ static int csi2_pad_set_fmt(struct v4l2_
 		u32 sink_code;
 		u32 code;
 
-		sink_fmt = v4l2_subdev_get_pad_format(sd, state,
+		sink_fmt = v4l2_subdev_state_get_format(state,
 			format->pad - CSI2_NUM_CHANNELS);
 		if (!sink_fmt)
 			return -EINVAL;
 
-		source_fmt = v4l2_subdev_get_pad_format(sd, state, format->pad);
+		source_fmt = v4l2_subdev_state_get_format(state, format->pad);
 		if (!source_fmt)
 			return -EINVAL;
 
@@ -549,8 +549,11 @@ static int csi2_pad_set_fmt(struct v4l2_
 	return 0;
 }
 
+static const struct v4l2_subdev_internal_ops csi2_internal_ops = {
+	.init_state = csi2_init_cfg,
+};
+
 static const struct v4l2_subdev_pad_ops csi2_subdev_pad_ops = {
-	.init_cfg = csi2_init_cfg,
 	.get_fmt = v4l2_subdev_get_fmt,
 	.set_fmt = csi2_pad_set_fmt,
 	.link_validate = v4l2_subdev_link_validate_default,
@@ -590,6 +593,7 @@ int csi2_init(struct csi2_device *csi2,
 
 	/* Initialize subdev */
 	v4l2_subdev_init(&csi2->sd, &csi2_subdev_ops);
+	csi2->sd.internal_ops = &csi2_internal_ops;
 	csi2->sd.entity.function = MEDIA_ENT_F_VID_IF_BRIDGE;
 	csi2->sd.entity.ops = &csi2_entity_ops;
 	csi2->sd.flags = V4L2_SUBDEV_FL_HAS_DEVNODE;
